import{_ as te,I as ae,L as se,k as ne,c as g,o as h,d as t,a as _,e as C,r as m,t as u,v as O,l as I,x as H,y as W,z as R,A as j,B as re,b as J,p as ie,f as p,C as V,E as v,F as K,h as le,G as ce,H as de,j as ue,J as he,i as fe,K as me,M as pe,N as we,O as ge}from"./appInit-CGHXFw0-.js";import{A as ye,I as Ce,a as ve,b as Pe,c as _e,i as x,s as be}from"./authPopupState-BwxecuRU.js";import{I as ke,a as Ie}from"./IconSend-ChvXYojB.js";import"./index-sC8Xq0xY.js";import"./IconMail-DCQdTgWz.js";import"./IconArrowRight-CAdyv1A0.js";import"./IconEye-CnVKG0J1.js";import"./IconX-CVTrmr_B.js";import"./IconSend-BZHPAH8O.js";window.onCaptchaForgotPasswordVerified=function(i){window._forgotPasswordInstance&&window._forgotPasswordInstance.handleCaptchaResponse(i)};window.onCaptchaForgotPasswordModalVerified=function(i){window._forgotPasswordInstance&&window._forgotPasswordInstance.handleCaptchaModalResponse(i)};let P=!1;const Te={name:"ForgotPasswordView",components:{ThemeToggle:ne,LanguageSelector:se,IconMail:_e,IconCode:Ie,IconLock:ae,IconArrowRight:Pe,IconSend:ke,IconEye:ve,IconEyeOff:Ce,AuthPopup:ye},setup(){const i=ue(),{t:o}=ie(),{showToast:y}=ce(),e=p(!1),T=p(0),D=p(!1),S=p(!1),b=p(""),M=p(!1),L=p(!1),U=V({title:v.popup?.title||"",content:v.popup?.content||"",cooldownHours:v.popup?.cooldownHours||24,closeWaitSeconds:v.popup?.closeWaitSeconds||0}),A=()=>{L.value=!1},E=p("./images/logo.png"),F=()=>{E.value="/images/logo.png"},f=V({is_email_verify:1,is_recaptcha:0,recaptcha_site_key:""}),l=V({type:K.captchaType,siteKey:"",verifyUrl:K[K.captchaType]?.verifyUrl||""}),c=V({email:"",verificationCode:"",newPassword:"",confirmPassword:""}),n=V({email:"",verificationCode:"",newPassword:"",confirmPassword:""}),z=p(!1),Q=p(!1),k=p(""),G=ge();G&&G.proxy&&(window._forgotPasswordInstance={handleCaptchaResponse:a=>{k.value=a},handleCaptchaModalResponse:a=>{a&&typeof a=="string"&&a.trim().length>0&&(b.value=a,setTimeout(()=>{N(),B(a)},300))}});const X=async()=>{try{const a=await me();a&&a.data&&(Object.assign(f,a.data),f.is_recaptcha===1&&(l.siteKey=f.recaptcha_site_key,await q()),D.value=!0,L.value=be(v.popup))}catch{y(o("messages.configLoadFailed"),"error")}},q=()=>new Promise(a=>{if(f.is_recaptcha!==1||!f.recaptcha_site_key){a();return}if(l.type==="google"&&window.grecaptcha){P=!1,a();return}if(window.turnstile&&l.type==="cloudflare"){console.log("Turnstile exists, trying reset instead of reloading script");try{window.turnstile.reset&&window.turnstile.reset();const s=document.getElementById("modal-turnstile");if(s){s.innerHTML="",setTimeout(()=>{window.turnstile.render("#modal-turnstile",{sitekey:l.siteKey,callback:function(d){window._forgotPasswordInstance&&window._forgotPasswordInstance.handleCaptchaModalResponse(d)},theme:document.body.classList.contains("dark-theme")?"dark":"light",retry:"auto","retry-interval":5e3,"refresh-expired":"manual",tabindex:0,execution:"render"}),a()},100);return}}catch(s){console.error("Failed to reset Turnstile, will try to reload script",s)}}if((()=>{const s=document.getElementById("modal-recaptcha");s&&(s.innerHTML="");const d=document.getElementById("modal-turnstile");d&&(d.innerHTML=""),P=!1})(),!window.turnstile||l.type!=="cloudflare"){const s=document.createElement("script");if(l.type==="google"){const d="https://www.recaptcha.net";s.src=`${d}/recaptcha/api.js?onload=captchaScriptLoaded&render=explicit`}else l.type==="cloudflare"&&(s.src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=captchaScriptLoaded&render=explicit");s.async=!0,s.defer=!0,window.captchaScriptLoaded=()=>{console.log("Captcha script loaded"),setTimeout(()=>{a()},100)},document.head.appendChild(s)}else a()}),Y=()=>{S.value=!0,b.value="",(async()=>{f.is_recaptcha===1&&l.siteKey&&(await q(),setTimeout(()=>{if(l.type==="google"&&window.grecaptcha){const r=document.getElementById("modal-recaptcha");if(r&&!P){r.innerHTML="";try{window.grecaptcha.render("modal-recaptcha",{sitekey:l.siteKey,callback:"onCaptchaForgotPasswordModalVerified",theme:document.body.classList.contains("dark-theme")?"dark":"light"}),P=!0}catch(s){console.error("Google reCAPTCHA render error:",s),s.toString().includes("has already been rendered")?P=!0:P=!1}}}else if(l.type==="cloudflare"&&window.turnstile){const r=document.getElementById("modal-turnstile");if(r){if(r.innerHTML="",window.turnstile.reset)try{window.turnstile.reset()}catch{console.log("Unable to reset Turnstile captcha, re-rendering")}try{window.turnstile.render("#modal-turnstile",{sitekey:l.siteKey,callback:function(s){window._forgotPasswordInstance&&window._forgotPasswordInstance.handleCaptchaModalResponse(s)},theme:document.body.classList.contains("dark-theme")?"dark":"light",retry:"auto","retry-interval":5e3,"refresh-expired":"manual",tabindex:0,execution:"render"})}catch(s){console.error("Turnstile render error:",s);const d=document.getElementsByTagName("script");for(let w=d.length-1;w>=0;w--)d[w].src.includes("turnstile")&&d[w].parentNode.removeChild(d[w]);setTimeout(()=>{const w=document.createElement("script");w.src="https://challenges.cloudflare.com/turnstile/v0/api.js?onload=captchaScriptLoaded&render=explicit",w.async=!0,w.defer=!0,document.head.appendChild(w)},500)}}else console.error("modal-turnstile container not found")}else console.error("Captcha script not loaded or misconfigured",{type:l.type,hasGoogle:!!window.grecaptcha,hasTurnstile:!!window.turnstile})},300))})()},N=()=>{M.value=!0,setTimeout(()=>{S.value=!1,M.value=!1,setTimeout(()=>{const a=document.getElementById("modal-recaptcha");a&&(a.innerHTML=""),P=!1},300)},300)},Z=a=>{a&&typeof a=="string"&&a.trim().length>0&&(b.value=a,setTimeout(()=>{N(),B(a)},300))},B=async a=>{try{e.value=!0;const r={email:c.email,isForgetPassword:!0};a&&(r.recaptcha_data=a);const s=await we(r);if(s&&s.data===!0){if(ee(),y(s.message||o("auth.codeSent"),"success"),v.verificationCode&&v.verificationCode.showCheckSpamTip){const d=v.verificationCode.checkSpamTipDelay||1e3;setTimeout(()=>{y(o("auth.checkSpam"),"info")},d)}}else throw new Error(s.message||o("auth.sendCodeFailed"))}catch(r){y(r.response?.message||r.message||o("auth.sendCodeFailed"),"error")}finally{e.value=!1}},$=async()=>{if(n.email="",!c.email){n.email=o("auth.emailRequired");return}if(!x(c.email)){n.email=o("auth.emailInvalid");return}if(f.is_recaptcha===1&&l.siteKey){const a=document.querySelector(".cloudflare-success-message")||document.querySelector(".recaptcha-success");if(!!k.value||a&&a.style.display!=="none"){const s=k.value||document.querySelector('[name="g-recaptcha-response"]')?.value||document.querySelector('[name="cf-turnstile-response"]')?.value;B(s)}else Y()}else B()},ee=()=>{T.value=60;const a=setInterval(()=>{T.value--,T.value<=0&&clearInterval(a)},1e3)},oe=async()=>{n.email="",n.verificationCode="",n.newPassword="",n.confirmPassword="";let a=!0;if(c.email?x(c.email)||(n.email=o("auth.emailInvalid"),a=!1):(n.email=o("auth.emailRequired"),a=!1),c.verificationCode||(n.verificationCode=o("auth.codeRequired"),a=!1),c.newPassword?c.newPassword.length<8&&(n.newPassword=o("auth.passwordTooShort"),a=!1):(n.newPassword=o("auth.passwordRequired"),a=!1),c.confirmPassword?c.newPassword!==c.confirmPassword&&(n.confirmPassword=o("auth.passwordsDoNotMatch"),a=!1):(n.confirmPassword=o("auth.confirmPasswordRequired"),a=!1),!!a)try{e.value=!0;const r={email:c.email,password:c.newPassword,email_code:parseInt(c.verificationCode)};if(f.is_recaptcha===1)if(k.value)r.recaptcha_data=k.value;else{const d=document.querySelector('[name="g-recaptcha-response"]')||document.querySelector('[name="cf-turnstile-response"]');d&&d.value&&(r.recaptcha_data=d.value)}const s=await pe(r);if(s.data===!0)y(s.message||o("auth.passwordResetSuccess"),"success"),i.push("/login");else throw new Error(s.message||o("auth.passwordResetFailed"))}catch(r){y(r.response?.message||r.message||o("auth.passwordResetFailed"),"error")}finally{e.value=!1}};return le(()=>{if(X(),window.addEventListener("focus",()=>{D.value&&f.is_recaptcha===1&&q()}),new URLSearchParams(window.location.search).get("logout")==="true"){if(y(o("auth.logoutSuccess"),"success"),window.history&&window.history.replaceState){const s=window.location.href.replace("?logout=true","").replace("&logout=true","");window.history.replaceState({},document.title,s)}return}try{if(window._isLoggingOut===!0)return;de()&&(y(o("auth.alreadyLoggedIn"),"info"),setTimeout(()=>{i.push("/dashboard")},500))}catch{}}),he(()=>{D.value&&f.is_recaptcha===1&&l.type==="cloudflare"&&(console.log("Component activated, reloading Cloudflare Turnstile"),q().then(()=>{if(window.turnstile&&window.turnstile.reset)try{window.turnstile.reset()}catch{console.log("Turnstile reset failed, re-rendering captcha component");const r=document.getElementById("modal-turnstile");r&&window.turnstile.render&&(r.innerHTML="",window.turnstile.render("#modal-turnstile",{sitekey:l.siteKey,callback:function(s){window._forgotPasswordInstance&&window._forgotPasswordInstance.handleCaptchaModalResponse(s)},theme:document.body.classList.contains("dark-theme")?"dark":"light","retry-interval":3e3}))}}))}),fe(()=>{if(P=!1,window.turnstile&&window.turnstile.reset)try{window.turnstile.reset()}catch(r){console.log("Turnstile reset failed",r)}const a=document.getElementById("modal-turnstile");a&&(a.innerHTML=""),k.value="",b.value="",window.captchaScriptLoaded=void 0,window.onCaptchaForgotPasswordVerified=void 0,window.onCaptchaForgotPasswordModalVerified=void 0,window._forgotPasswordInstance=null}),{formData:c,errors:n,loading:e,cooldown:T,sendVerificationCode:$,handleSubmit:oe,isValidEmail:x,showPassword:z,showConfirmPassword:Q,logoPath:E,handleLogoError:F,config:f,captchaConfig:l,showCaptchaModal:S,closeCaptchaModal:N,handleCaptchaModalResponse:Z,isClosingModal:M,showAuthPopup:L,authPopupConfig:U,handleAuthPopupClose:A}}},Se={class:"auth-container"},Me={class:"top-toolbar"},Le={class:"auth-card"},Ee={class:"auth-header"},Re={class:"auth-logo"},Ve=["src"],De={class:"auth-title"},Ae={class:"auth-subtitle"},Fe={class:"form-group"},qe={for:"email"},Be={class:"input-with-icon"},He=["placeholder"],Ue={key:0,class:"error-message"},Ne={class:"form-group"},Oe={for:"verificationCode"},Ke={class:"input-with-button"},xe={class:"input-with-icon verification-input"},Ge=["placeholder"],We=["disabled"],je={key:0,class:"error-message"},Je={class:"form-group"},ze={for:"newPassword"},Qe={class:"input-with-icon"},Xe=["type","placeholder"],Ye={key:0,class:"error-message"},Ze={class:"form-group"},$e={for:"confirmPassword"},eo={class:"input-with-icon"},oo=["type","placeholder"],to={key:0,class:"error-message"},ao=["disabled"],so={key:0,class:"loading-wrapper"},no={key:1},ro={class:"auth-footer"},io={class:"auth-divider"},lo={class:"auth-divider-text"},co={class:"captcha-modal-header"},uo={class:"captcha-modal-body"};function ho(i,o,y,e,T,D){const S=m("ThemeToggle"),b=m("LanguageSelector"),M=m("IconMail"),L=m("IconCode"),U=m("IconSend"),A=m("IconLock"),E=m("IconEye"),F=m("IconEyeOff"),f=m("IconArrowRight"),l=m("router-link"),c=m("AuthPopup");return h(),g("div",Se,[o[20]||(o[20]=t("div",{class:"background-decoration"},[t("div",{class:"floating-ball ball-1"}),t("div",{class:"floating-ball ball-2"}),t("div",{class:"floating-ball ball-3"})],-1)),t("div",Me,[C(S),C(b)]),t("div",Le,[t("div",Ee,[t("div",Re,[t("img",{src:e.logoPath,alt:"Logo",onError:o[0]||(o[0]=(...n)=>e.handleLogoError&&e.handleLogoError(...n))},null,40,Ve)]),t("h1",De,u(i.$t("auth.forgotPasswordTitle")),1),t("p",Ae,u(i.$t("auth.forgotPasswordSubtitle")),1)]),t("form",{class:"auth-form",onSubmit:o[8]||(o[8]=O((...n)=>e.handleSubmit&&e.handleSubmit(...n),["prevent"]))},[t("div",Fe,[t("label",qe,[I(u(i.$t("common.email"))+" ",1),o[13]||(o[13]=t("span",{class:"required"},"*",-1))]),t("div",Be,[C(M,{class:"input-icon"}),H(t("input",{type:"email",id:"email",class:"form-control","onUpdate:modelValue":o[1]||(o[1]=n=>e.formData.email=n),placeholder:i.$t("auth.emailPlaceholder")},null,8,He),[[W,e.formData.email]])]),e.errors.email?(h(),g("div",Ue,u(e.errors.email),1)):_("",!0)]),t("div",Ne,[t("label",Oe,[I(u(i.$t("common.verificationCode"))+" ",1),o[14]||(o[14]=t("span",{class:"required"},"*",-1))]),t("div",Ke,[t("div",xe,[C(L,{class:"input-icon"}),H(t("input",{type:"text",id:"verificationCode",class:"form-control","onUpdate:modelValue":o[2]||(o[2]=n=>e.formData.verificationCode=n),placeholder:i.$t("auth.codePlaceholder")},null,8,Ge),[[W,e.formData.verificationCode]])]),t("button",{class:"send-code-btn",onClick:o[3]||(o[3]=(...n)=>e.sendVerificationCode&&e.sendVerificationCode(...n)),disabled:!e.isValidEmail(e.formData.email)||e.cooldown>0||e.loading,type:"button"},[e.cooldown===0?(h(),R(U,{key:0,class:"icon-left"})):_("",!0),t("span",null,u(e.cooldown>0?`${e.cooldown}s`:i.$t("common.sendCode")),1)],8,We)]),e.errors.verificationCode?(h(),g("div",je,u(e.errors.verificationCode),1)):_("",!0)]),t("div",Je,[t("label",ze,[I(u(i.$t("auth.newPassword"))+" ",1),o[15]||(o[15]=t("span",{class:"required"},"*",-1))]),t("div",Qe,[C(A,{class:"input-icon"}),H(t("input",{type:e.showPassword?"text":"password",id:"newPassword",class:"form-control","onUpdate:modelValue":o[4]||(o[4]=n=>e.formData.newPassword=n),placeholder:i.$t("auth.newPasswordPlaceholder")},null,8,Xe),[[j,e.formData.newPassword]]),t("div",{class:"password-toggle",onClick:o[5]||(o[5]=n=>e.showPassword=!e.showPassword)},[e.showPassword?(h(),R(F,{key:1})):(h(),R(E,{key:0}))])]),e.errors.newPassword?(h(),g("div",Ye,u(e.errors.newPassword),1)):_("",!0)]),t("div",Ze,[t("label",$e,[I(u(i.$t("common.confirmPassword"))+" ",1),o[16]||(o[16]=t("span",{class:"required"},"*",-1))]),t("div",eo,[C(A,{class:"input-icon"}),H(t("input",{type:e.showConfirmPassword?"text":"password",id:"confirmPassword",class:"form-control","onUpdate:modelValue":o[6]||(o[6]=n=>e.formData.confirmPassword=n),placeholder:i.$t("auth.confirmPasswordPlaceholder")},null,8,oo),[[j,e.formData.confirmPassword]]),t("div",{class:"password-toggle",onClick:o[7]||(o[7]=n=>e.showConfirmPassword=!e.showConfirmPassword)},[e.showConfirmPassword?(h(),R(F,{key:1})):(h(),R(E,{key:0}))])]),e.errors.confirmPassword?(h(),g("div",to,u(e.errors.confirmPassword),1)):_("",!0)]),t("button",{class:"btn btn-primary btn-block",disabled:e.loading||!e.formData.email||!e.formData.verificationCode||!e.formData.newPassword||!e.formData.confirmPassword,type:"submit"},[e.loading?(h(),g("span",so,[t("span",null,u(i.$t("common.loading")),1)])):(h(),g("span",no,[I(u(i.$t("common.resetPassword"))+" ",1),C(f,{class:"icon-right"})]))],8,ao)],32),t("div",ro,[t("div",io,[t("span",lo,u(i.$t("auth.rememberPassword")),1)]),C(l,{to:"/login",class:"btn btn-secondary btn-block"},{default:re(()=>[I(u(i.$t("common.login")),1)]),_:1})])]),e.showCaptchaModal?(h(),g("div",{key:0,class:J(["captcha-modal",{closing:e.isClosingModal}])},[t("div",{class:"captcha-modal-overlay",onClick:o[9]||(o[9]=(...n)=>e.closeCaptchaModal&&e.closeCaptchaModal(...n))}),t("div",{class:J(["captcha-modal-content",{closing:e.isClosingModal}])},[t("div",co,[t("h3",null,u(i.$t("auth.captcha")),1),t("button",{class:"close-btn",onClick:o[10]||(o[10]=(...n)=>e.closeCaptchaModal&&e.closeCaptchaModal(...n))},[...o[17]||(o[17]=[t("span",null,"×",-1)])])]),t("div",uo,[t("p",null,u(i.$t("auth.captchaRequired")),1),e.captchaConfig.type==="google"?(h(),g("div",{key:0,class:"google-captcha",onClick:o[11]||(o[11]=O(()=>{},["stop"]))},[...o[18]||(o[18]=[t("div",{id:"modal-recaptcha"},null,-1)])])):e.captchaConfig.type==="cloudflare"?(h(),g("div",{key:1,class:"cloudflare-captcha",onClick:o[12]||(o[12]=O(()=>{},["stop"]))},[...o[19]||(o[19]=[t("div",{id:"modal-turnstile"},null,-1)])])):_("",!0)])],2)],2)):_("",!0),C(c,{"show-popup":e.showAuthPopup,title:e.authPopupConfig.title,content:e.authPopupConfig.content,"cooldown-hours":e.authPopupConfig.cooldownHours,"close-wait-seconds":e.authPopupConfig.closeWaitSeconds,onClose:e.handleAuthPopupClose},null,8,["show-popup","title","content","cooldown-hours","close-wait-seconds","onClose"])])}const _o=te(Te,[["render",ho],["__scopeId","data-v-813475f2"]]);export{_o as default};
