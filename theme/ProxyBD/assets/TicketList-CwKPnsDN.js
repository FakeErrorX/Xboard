import{_ as be,p as we,f as u,g as Te,aO as Ce,h as $e,s as Ie,c as i,o,e as v,d as s,ai as n,t as l,a0 as V,a as f,x as U,y as E,l as g,a9 as ae,b as m,aP as Me,v as K,z as w,G as Se,j as ze,aj as je,al as Le,aq as De,aQ as Pe,aR as Fe,aF as Re,aS as Ve,aJ as Ue}from"./appInit-CGHXFw0-.js";import{I as O,a as W}from"./IconCircle-C-OUj5TY.js";import{I as Ee}from"./IconDeviceMobile-CvoVo5Ai.js";import{I as Ne}from"./IconLock-Dm1Qu8SN.js";import{T as He,f as Ae,r as qe,c as Be,a as Ke,g as Oe,I as We}from"./TicketPopup-BQyoIwXl.js";import{I as Ge}from"./IconMessage-BxCmZijD.js";import{I as Qe}from"./IconSearch-C51NJCct.js";import{I as Ye}from"./IconSend-BZHPAH8O.js";import{I as Je}from"./IconTicket-DomXdQwZ.js";import{I as le}from"./IconX-CVTrmr_B.js";import{L as oe}from"./LoadingSpinner-C-1wdek1.js";import"./index-sC8Xq0xY.js";const Xe={class:"ticket-container"},Ze={key:0,class:"screen-size-notice"},xe={class:"notice-content"},es={class:"dashboard-card welcome-card"},ss={class:"card-header"},ts={class:"card-title"},as={class:"card-body"},ls={class:"ticket-list-container"},os={class:"ticket-sidebar"},is={class:"ticket-header"},cs={class:"search-box"},ns=["placeholder"],rs={key:0,class:"ticket-list"},us=["onClick"],ds={class:"ticket-info"},vs={class:"ticket-subject"},ms={class:"ticket-meta"},ks={class:"ticket-time"},hs={class:"ticket-status"},ps={key:1,class:"ticket-loading"},fs={key:2,class:"empty-state"},gs={class:"ticket-content"},_s={class:"ticket-detail-header"},ys={class:"ticket-subject-info"},bs={class:"ticket-detail-meta"},ws={class:"ticket-time"},Ts={class:"ticket-actions"},Cs=["disabled"],$s={key:0},Is={key:1,class:"loading-text"},Ms={class:"ticket-detail-content"},Ss={class:"ticket-messages"},zs={key:0,class:"message-loading"},js={key:1,class:"no-messages"},Ls={key:0,class:"message-avatar admin-avatar"},Ds={class:"message-content"},Ps={class:"message-header"},Fs={key:0,class:"message-sender"},Rs={class:"message-text"},Vs={key:1,class:"message-avatar user-avatar"},Us={class:"message-time-floating"},Es={key:0,class:"reply-container"},Ns=["placeholder","onKeydown"],Hs=["disabled"],As={key:0,class:"loader"},qs={key:1,class:"ticket-closed-notice"},Bs={key:1,class:"no-selection"},Ks={class:"modal-header"},Os={class:"modal-body"},Ws={class:"form-group"},Gs=["placeholder"],Qs={class:"form-group"},Ys={class:"level-tags"},Js={class:"form-group"},Xs=["placeholder"],Zs={class:"modal-footer"},xs=["disabled"],et={key:0,class:"loader"},st={class:"modal-header"},tt={class:"modal-body"},at={class:"modal-footer"},lt=["disabled"],ot={key:0,class:"loader"},it={__name:"TicketList",setup(ct){const{t:d}=we(),{showToast:h}=Se(),_=u([]),c=u(null),S=u(""),N=u(!1),z=u(!1),T=u([]),H=u(!1),C=u(""),j=u(!1),y=u(!1),$=u(!1),L=u(!1),D=u(null),P=u({subject:"",message:""}),r=u({subject:"",message:"",level:"0"}),ie=Te(()=>{if(!S.value)return _.value;const e=S.value.toLowerCase();return _.value.filter(t=>t.subject.toLowerCase().includes(e))}),A=async()=>{L.value=!0;try{const e=await Ae();_.value=Array.isArray(e.data)?e.data:[]}catch(e){console.error("Failed to fetch tickets:",e),h(e.response?.message||e.message||d("tickets.fetchError"),"error"),_.value=[]}finally{L.value=!1}},ce=async()=>{if(r.value.subject.trim())P.value.subject="";else{P.value.subject=d("tickets.subjectRequired");return}if(r.value.message.trim())P.value.message="";else{P.value.message=d("tickets.messageRequired");return}z.value=!0;try{const[e,t,a,p]=await Promise.all([je(),Le(),De(),Pe()]);t&&t.data&&t.data.currency_symbol&&(e.currency_symbol=t.data.currency_symbol);const ge=Fe(e,p,a),_e=`${r.value.message}

${ge}`,te=await Be({subject:r.value.subject,message:_e,level:parseInt(r.value.level)});if(te.data&&(h(te.message||d("tickets.createSuccess"),"success"),R(),await A(),_.value.length>0)){const ye=_.value[0];x(ye)}}catch(e){console.error("Failed to create ticket:",e),h(e.response?.message||e.message||d("tickets.createError"),"error")}finally{z.value=!1}},F=async(e,t=!1)=>{t||(H.value=!0,T.value=[]);try{const a=await Oe(e);a.data&&(a.data.message&&Array.isArray(a.data.message)?T.value=a.data.message.map(p=>({...p,is_admin:!p.is_me})):T.value=[],c.value&&c.value.id===e&&a.data.status!==void 0&&(c.value.status=a.data.status,a.data.status===1&&I()))}catch(a){console.error("Failed to fetch ticket details:",a),h(a.response?.message||a.message||d("tickets.fetchDetailError"),"error")}finally{t||(H.value=!1)}},I=()=>{D.value&&(clearInterval(D.value),D.value=null)},ne=e=>{I(),c.value&&c.value.status===0&&(D.value=setInterval(()=>{c.value&&c.value.id===e?F(e,!0):I()},5e3))},G=async()=>{if(!(!C.value.trim()||!c.value)){j.value=!0;try{const e=await qe(c.value.id,C.value);e.data&&(h(e.message||d("tickets.replySent"),"success"),C.value="",await F(c.value.id,!0))}catch(e){console.error("Failed to send reply:",e),h(e.response?.message||e.message||d("tickets.replyError"),"error")}finally{j.value=!1}}},re=async()=>{if(c.value){$.value=!0;try{const e=await Ke(c.value.id);e.data===!0&&(h(e.message||d("tickets.closeSuccess"),"success"),c.value.status=1,I(),await F(c.value.id),await A(),k.value=!0,b.value=!1,setTimeout(()=>{y.value=!1,k.value=!1},250))}catch(e){console.error("Failed to close ticket:",e),h(e.response?.message||e.message||d("tickets.closeError"),"error")}finally{$.value=!1}}},Q=e=>e?new Date(e*1e3).toLocaleString():"--",Y=e=>d(e===0?"tickets.statusOpen":"tickets.statusClosed"),J=e=>e===0?"status-open":"status-closed",X=e=>{const t={0:d("tickets.levelLow"),1:d("tickets.levelMedium"),2:d("tickets.levelHigh")};return t[e]||t[0]},Z=e=>{const t={0:"level-low",1:"level-medium",2:"level-high"};return t[e]||t[0]},ue=()=>{},x=e=>{I(),c.value=e,F(e.id),e.status===0&&ne(e.id)},k=u(!1),b=u(!1),R=()=>{k.value=!0,b.value=!1,setTimeout(()=>{N.value=!1,k.value=!1,r.value={subject:"",message:"",level:"0"}},250)},de=()=>{k.value=!1,N.value=!0,setTimeout(()=>{b.value=!0},10)},ee=()=>{y.value?(k.value=!0,b.value=!1,setTimeout(()=>{y.value=!1,k.value=!1},250)):(k.value=!1,y.value=!0,setTimeout(()=>{b.value=!0},10))},ve=(e,t)=>e===0?!0:T.value[e-1].is_admin!==t,me=e=>{if(!e)return"--";const t=new Date(e*1e3),a=new Date;return t.getDate()===a.getDate()&&t.getMonth()===a.getMonth()&&t.getFullYear()===a.getFullYear()?t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):t.getDate()+" "+t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},se=u(!1),ke=ze(),q=()=>{se.value=window.innerWidth<905},he=()=>{ke.push("/mobile/tickets")},B=u(!1),M=Ce?.popup||{},pe=()=>{if(!M.enabled)return;const e=Number(localStorage.getItem("ticket_popup_close_time")||0),t=(M.cooldownHours||0)*3600*1e3;(!e||Date.now()-e>=t)&&(B.value=!0)},fe=()=>{B.value=!1};return $e(()=>{q(),window.addEventListener("resize",q),A(),pe()}),Ie(()=>{window.removeEventListener("resize",q),I()}),(e,t)=>(o(),i("div",Xe,[se.value?(o(),i("div",Ze,[s("div",xe,[v(n(Ee),{size:48}),s("h2",null,l(e.$t("tickets.smallScreenNotice")),1),s("p",null,l(e.$t("tickets.switchToMobile")),1),s("button",{class:"switch-btn",onClick:he},l(e.$t("tickets.switchToMobileView")),1)])])):(o(),i(V,{key:1},[s("div",es,[s("div",ss,[s("h2",ts,l(e.$t("tickets.title")),1)]),s("div",as,[s("p",null,l(e.$t("tickets.description")),1)])]),s("div",ls,[s("div",os,[s("div",is,[s("div",cs,[U(s("input",{type:"text","onUpdate:modelValue":t[0]||(t[0]=a=>S.value=a),placeholder:e.$t("tickets.searchPlaceholder"),onInput:ue},null,40,ns),[[E,S.value]]),v(n(Qe),{size:16,class:"search-icon"})]),s("button",{class:"new-ticket-btn",onClick:de},[v(n(Re),{size:16}),g(" "+l(e.$t("tickets.newTicket")),1)])]),_.value.length>0&&!L.value?(o(),i("div",rs,[(o(!0),i(V,null,ae(ie.value,a=>(o(),i("div",{key:a.id,class:m(["ticket-item",{active:c.value?.id===a.id}]),onClick:p=>x(a)},[s("div",ds,[s("h3",vs,l(a.subject),1),s("div",ms,[s("span",ks,l(Q(a.updated_at)),1),s("div",hs,[s("span",{class:m(["status-badge",J(a.status)])},l(Y(a.status)),3),s("span",{class:m(["level-badge",Z(a.level)])},l(X(a.level)),3)])])])],10,us))),128))])):L.value?(o(),i("div",ps,[v(oe),s("p",null,l(e.$t("tickets.loadingTickets")),1)])):(o(),i("div",fs,[v(n(Je),{size:48,class:"empty-icon"}),s("p",null,l(e.$t("tickets.noTickets")),1)]))]),s("div",gs,[c.value?(o(),i(V,{key:0},[s("div",_s,[s("div",ys,[s("h2",null,l(c.value.subject),1),s("div",bs,[s("span",{class:m(["status-badge",J(c.value.status)])},l(Y(c.value.status)),3),s("span",{class:m(["level-badge",Z(c.value.level)])},l(X(c.value.level)),3),s("span",ws,l(e.$t("tickets.createdAt"))+": "+l(Q(c.value.created_at)),1)])]),s("div",Ts,[c.value.status===0?(o(),i("button",{key:0,class:"close-ticket-btn",onClick:t[1]||(t[1]=a=>ee()),disabled:$.value},[$.value?(o(),i("span",Is,[t[12]||(t[12]=s("span",{class:"loading-spinner"},null,-1)),g(" "+l(e.$t("tickets.closing")),1)])):(o(),i("span",$s,l(e.$t("tickets.closeTicket")),1))],8,Cs)):f("",!0)])]),s("div",Ms,[s("div",Ss,[H.value?(o(),i("div",zs,[v(oe),s("p",null,l(e.$t("tickets.loadingMessages")),1)])):T.value.length===0?(o(),i("div",js,[v(n(We),{size:64,class:"no-messages-icon"}),s("p",null,l(e.$t("tickets.noMessages")),1)])):(o(!0),i(V,{key:2},ae(T.value,(a,p)=>(o(),i("div",{key:a.id,class:m(["message-item",{"admin-message":a.is_admin,"user-message":!a.is_admin}])},[a.is_admin?(o(),i("div",Ls,[v(n(Ve))])):f("",!0),s("div",Ds,[s("div",Ps,[ve(p,a.is_admin)?(o(),i("span",Fs,l(a.is_admin?e.$t("tickets.admin"):e.$t("tickets.you")),1)):f("",!0)]),s("div",Rs,l(a.message),1)]),a.is_admin?f("",!0):(o(),i("div",Vs,[v(n(Ue))])),s("span",Us,l(me(a.created_at)),1)],2))),128))])]),c.value.status===0?(o(),i("div",Es,[U(s("textarea",{"onUpdate:modelValue":t[2]||(t[2]=a=>C.value=a),placeholder:e.$t("tickets.replyPlaceholder"),rows:"3",onKeydown:Me(K(G,["ctrl"]),["enter"])},null,40,Ns),[[E,C.value]]),s("button",{class:"send-reply-btn",onClick:G,disabled:!C.value.trim()||j.value},[j.value?(o(),i("span",As)):(o(),w(n(Ye),{key:1,size:18})),g(" "+l(e.$t("tickets.send")),1)],8,Hs)])):(o(),i("div",qs,[v(n(Ne),{size:20}),s("span",null,l(e.$t("tickets.ticketClosed")),1)]))],64)):(o(),i("div",Bs,[v(n(Ge),{size:64,class:"no-selection-icon"}),s("p",null,l(e.$t("tickets.selectTicket")),1)]))])]),N.value?(o(),i("div",{key:0,class:m(["modal-overlay",{"show-overlay":b.value}]),onClick:R},[s("div",{class:m(["modal-content",{"modal-close-animation":k.value}]),onClick:t[8]||(t[8]=K(()=>{},["stop"]))},[s("div",Ks,[s("h3",null,l(e.$t("tickets.createNew")),1),s("button",{class:"modal-close",onClick:R},[v(n(le),{size:20})])]),s("div",Os,[s("div",Ws,[s("label",null,l(e.$t("tickets.subject")),1),U(s("input",{type:"text","onUpdate:modelValue":t[3]||(t[3]=a=>r.value.subject=a),placeholder:e.$t("tickets.subjectPlaceholder")},null,8,Gs),[[E,r.value.subject]])]),s("div",Qs,[s("label",null,l(e.$t("tickets.level")),1),s("div",Ys,[s("div",{class:m(["level-tag",{active:r.value.level==="0","level-low":!0}]),onClick:t[4]||(t[4]=a=>r.value.level="0")},[r.value.level==="0"?(o(),w(n(O),{key:0,size:16,class:"tag-icon"})):(o(),w(n(W),{key:1,size:16,class:"tag-icon"})),g(" "+l(e.$t("tickets.levelLow")),1)],2),s("div",{class:m(["level-tag",{active:r.value.level==="1","level-medium":!0}]),onClick:t[5]||(t[5]=a=>r.value.level="1")},[r.value.level==="1"?(o(),w(n(O),{key:0,size:16,class:"tag-icon"})):(o(),w(n(W),{key:1,size:16,class:"tag-icon"})),g(" "+l(e.$t("tickets.levelMedium")),1)],2),s("div",{class:m(["level-tag",{active:r.value.level==="2","level-high":!0}]),onClick:t[6]||(t[6]=a=>r.value.level="2")},[r.value.level==="2"?(o(),w(n(O),{key:0,size:16,class:"tag-icon"})):(o(),w(n(W),{key:1,size:16,class:"tag-icon"})),g(" "+l(e.$t("tickets.levelHigh")),1)],2)])]),s("div",Js,[s("label",null,l(e.$t("tickets.message")),1),U(s("textarea",{"onUpdate:modelValue":t[7]||(t[7]=a=>r.value.message=a),placeholder:e.$t("tickets.messagePlaceholder"),rows:"5"},null,8,Xs),[[E,r.value.message]])])]),s("div",Zs,[s("button",{class:"btn-cancel",onClick:R},l(e.$t("common.cancel")),1),s("button",{class:"btn-submit",onClick:ce,disabled:z.value,type:"button"},[z.value?(o(),i("span",et)):f("",!0),g(" "+l(e.$t("common.submit")),1)],8,xs)])],2)],2)):f("",!0),y.value?(o(),i("div",{key:1,class:m(["modal-overlay",{"show-overlay":b.value}]),onClick:ee},[s("div",{class:m(["modal-content",{"modal-close-animation":k.value}]),onClick:t[11]||(t[11]=K(()=>{},["stop"]))},[s("div",st,[s("h3",null,l(e.$t("tickets.closeConfirmTitle")),1),s("button",{class:"modal-close",onClick:t[9]||(t[9]=a=>y.value=!1)},[v(n(le),{size:20})])]),s("div",tt,[s("p",null,l(e.$t("tickets.closeConfirmText")),1)]),s("div",at,[s("button",{class:"btn-cancel",onClick:t[10]||(t[10]=a=>y.value=!1)},l(e.$t("common.cancel")),1),s("button",{class:"btn-submit",onClick:re,disabled:$.value},[$.value?(o(),i("span",ot)):f("",!0),g(" "+l(e.$t("common.confirm")),1)],8,lt)])],2)],2)):f("",!0)],64)),v(He,{"show-popup":B.value,title:n(M).title,content:n(M).content,"cooldown-hours":n(M).cooldownHours,"close-wait-seconds":n(M).closeWaitSeconds,onClose:fe},null,8,["show-popup","title","content","cooldown-hours","close-wait-seconds"])]))}},yt=be(it,[["__scopeId","data-v-2f61e4bd"]]);export{yt as default};
