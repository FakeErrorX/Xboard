import{_ as ue,p as ve,f as d,aO as J,h as ke,s as me,G as pe,c,o as l,a as L,e as v,d as s,ai as n,t as a,a0 as M,l as D,a9 as U,b as w,x as V,y as q,aP as he,v as A,z as B,j as fe,aj as ge,al as _e,aq as ye,aQ as be,aR as we,a5 as Te,aF as Ce,aS as $e,aJ as Ie}from"./appInit-CGHXFw0-.js";import{I as Se}from"./IconArrowLeft-6FkQlYes.js";import{I as Le}from"./IconLock-Dm1Qu8SN.js";import{f as Me,T as De,r as je,c as ze,a as Pe,g as Fe,I as Ee}from"./TicketPopup-BQyoIwXl.js";import{I as Ne}from"./IconSend-BZHPAH8O.js";import{I as Re}from"./IconTicket-DomXdQwZ.js";import{I as H}from"./IconX-CVTrmr_B.js";import{L as Q}from"./LoadingSpinner-C-1wdek1.js";import"./index-sC8Xq0xY.js";const Ue={class:"mobile-ticket-container"},Ve={key:0,class:"screen-size-notice"},qe={class:"notice-content"},Ae={class:"dashboard-card welcome-card"},Be={class:"card-header"},He={class:"card-title"},Ke={class:"card-body"},Oe={key:0,class:"ticket-list"},Ge={class:"create-ticket-wrapper"},We={key:0,class:"loading-state"},Ye={key:1,class:"tickets-content"},Je=["onClick"],Qe={class:"ticket-header"},Xe={class:"ticket-subject"},Ze={class:"ticket-info"},xe={class:"ticket-time"},es={class:"ticket-id"},ss={key:2,class:"empty-state"},ts={key:1,class:"ticket-detail"},as={class:"detail-header"},os={class:"ticket-info"},ls={class:"meta-info"},cs={class:"messages-container"},is={key:0,class:"loading-state"},ns={key:1,class:"empty-messages"},rs={key:2,class:"message-list"},ds={class:"message-avatar"},us={class:"message-content"},vs={class:"message-header"},ks={class:"sender-name"},ms={class:"message-time"},ps={class:"message-text"},hs={key:0,class:"reply-box"},fs=["placeholder","onKeydown"],gs=["disabled"],_s={key:0,class:"loader"},ys={key:1,class:"ticket-closed-notice"},bs={class:"modal-header"},ws={class:"modal-body"},Ts={class:"form-group"},Cs=["placeholder"],$s={class:"form-group"},Is={class:"priority-selector"},Ss=["onClick"],Ls={class:"form-group"},Ms=["placeholder"],Ds={class:"modal-footer"},js=["disabled"],zs={key:0,class:"loader"},Ps={class:"modal-header"},Fs={class:"modal-body"},Es={class:"modal-footer"},Ns=["disabled"],Rs={key:0},Us={key:1,class:"btn-loading"},Vs={__name:"MobileTicketList",setup(qs){const{t:u}=ve(),{showToast:m}=pe(),X=fe(),j=d(!1),z=d([]),T=d(!1),C=d(!1),i=d(null),_=d([]),P=d(!1),h=d(""),y=d(!1),b=d(!1),f=d(!1),$=d(null),r=d({subject:"",message:"",level:0}),K=d(!1),F=d(!1),g=J?.popup||{},E=()=>{K.value=window.innerWidth>=905},Z=()=>{X.push("/tickets")};ke(()=>{E(),window.addEventListener("resize",E),S(),ce()}),me(()=>{window.removeEventListener("resize",E),p()});const O=e=>{const o={0:u("tickets.levelLow"),1:u("tickets.levelMedium"),2:u("tickets.levelHigh")};return o[e]||o[0]},x=e=>e?new Date(e*1e3).toLocaleString():"--",ee=e=>{if(!e)return"--";const o=new Date(e*1e3),t=new Date;return o.getDate()===t.getDate()&&o.getMonth()===t.getMonth()&&o.getFullYear()===t.getFullYear()?o.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):o.toLocaleDateString([],{month:"short",day:"numeric"})+" "+o.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})},G=()=>{T.value=!0},I=()=>{const e=document.querySelector(".modal-content");e?(e.classList.add("closing"),setTimeout(()=>{T.value=!1,r.value={subject:"",message:"",level:0}},300)):(T.value=!1,r.value={subject:"",message:"",level:0})},N=async(e,o=!1)=>{o||(P.value=!0,_.value=[]);try{const t=await Fe(e);t.data&&(t.data.message&&Array.isArray(t.data.message)?_.value=t.data.message.map(k=>({...k,is_admin:!k.is_me})):_.value=[],i.value&&i.value.id===e&&t.data.status!==void 0&&(i.value.status=t.data.status,t.data.status===1&&p()))}catch(t){console.error("Failed to fetch ticket details:",t),m(t.response?.message||t.message||u("tickets.fetchDetailError"),"error")}finally{o||(P.value=!1)}},p=()=>{$.value&&(clearInterval($.value),$.value=null)},se=e=>{p(),i.value&&i.value.status===0&&($.value=setInterval(()=>{i.value&&i.value.id===e?N(e,!0):p()},5e3))},te=async e=>{p(),i.value=e,await N(e.id),e.status===0&&se(e.id)},W=()=>{p();const e=document.querySelector(".ticket-detail");e?(e.classList.add("closing"),setTimeout(()=>{i.value=null},280)):i.value=null},S=async()=>{j.value=!0;try{const e=await Me();z.value=Array.isArray(e.data)?e.data:[]}catch(e){console.error("Failed to fetch tickets:",e),m(e.response?.message||e.message||u("tickets.fetchError"),"error")}finally{j.value=!1}},Y=async()=>{if(!(!h.value.trim()||!i.value||y.value)){y.value=!0;try{const e=await je(i.value.id,h.value);e.data&&(m(e.message||u("tickets.replySent"),"success"),h.value="",await N(i.value.id,!0))}catch(e){console.error("Failed to send reply:",e),m(e.response?.message||e.message||u("tickets.replyError"),"error")}finally{y.value=!1}}},ae=()=>{b.value=!0},R=()=>{const e=document.querySelector(".modal-content");e?(e.classList.add("closing"),setTimeout(()=>{b.value=!1,f.value=!1},300)):(b.value=!1,f.value=!1)},oe=async()=>{if(i.value){f.value=!0;try{const e=await Pe(i.value.id);e.data===!0&&(m(e.message||u("tickets.closeSuccess"),"success"),b.value=!1,i.value.status=1,await S(),p(),W())}catch(e){console.error("Failed to close ticket:",e),m(e.response?.message||e.message||u("tickets.closeError"),"error")}finally{f.value=!1}}},le=async()=>{if(!r.value.subject||!r.value.message){m(u("tickets.formIncomplete"),"error");return}C.value=!0;try{let e=r.value.message;if(J.includeUserInfoInTicket){const[t,k,ne,re]=await Promise.all([ge(),_e(),ye(),be()]);k&&k.data&&k.data.currency_symbol&&(t.currency_symbol=k.data.currency_symbol);const de=we(t,re,ne);e=`${r.value.message}

${de}`}const o=await ze({subject:r.value.subject,message:e,level:parseInt(r.value.level)});o.data&&(m(o.message||u("tickets.createSuccess"),"success"),I(),await S(),r.value={subject:"",message:"",level:"0"})}catch(e){console.error("Failed to create ticket:",e),m(e.response?.message||e.message||u("tickets.createError"),"error")}finally{C.value=!1}},ce=()=>{if(!g.enabled)return;const e=Number(localStorage.getItem("ticket_popup_close_time")||0),o=(g.cooldownHours||0)*3600*1e3;(!e||Date.now()-e>=o)&&(F.value=!0)},ie=()=>{F.value=!1};return S(),(e,o)=>(l(),c("div",Ue,[K.value?(l(),c("div",Ve,[s("div",qe,[v(n(Te),{size:48}),s("h2",null,a(e.$t("tickets.largeScreenNotice")),1),s("p",null,a(e.$t("tickets.switchToDesktop")),1),s("button",{class:"switch-btn",onClick:Z},a(e.$t("tickets.switchToDesktopView")),1)])])):(l(),c(M,{key:1},[s("div",Ae,[s("div",Be,[s("h2",He,a(e.$t("tickets.title")),1)]),s("div",Ke,[s("p",null,a(e.$t("tickets.description")),1)])]),i.value?(l(),c("div",ts,[s("div",as,[s("button",{class:"back-btn",onClick:W},[v(n(Se),{size:20})]),s("div",os,[s("h2",null,a(i.value.subject),1),s("div",ls,[s("span",{class:w(["status-badge",`status-${i.value.status}`])},a(i.value.status===0?e.$t("tickets.statusOpen"):e.$t("tickets.statusClosed")),3),s("span",{class:w(["level-badge",`level-${i.value.level}`])},a(O(i.value.level)),3)])]),i.value.status===0?(l(),c("button",{key:0,class:"close-ticket-btn",onClick:ae},[v(n(H),{size:16})])):L("",!0)]),s("div",cs,[P.value?(l(),c("div",is,[v(Q),s("p",null,a(e.$t("tickets.loadingMessages")),1)])):_.value.length===0?(l(),c("div",ns,[v(n(Ee),{size:48}),s("p",null,a(e.$t("tickets.noMessages")),1)])):(l(),c("div",rs,[(l(!0),c(M,null,U(_.value,t=>(l(),c("div",{key:t.id,class:w(["message-item",t.is_admin?"admin-message":"user-message"])},[s("div",ds,[t.is_admin?(l(),B(n($e),{key:0})):(l(),B(n(Ie),{key:1}))]),s("div",us,[s("div",vs,[s("span",ks,a(t.is_admin?e.$t("tickets.admin"):e.$t("tickets.you")),1),s("span",ms,a(ee(t.created_at)),1)]),s("div",ps,a(t.message),1)])],2))),128))]))]),i.value.status===0?(l(),c("div",hs,[V(s("textarea",{"onUpdate:modelValue":o[0]||(o[0]=t=>h.value=t),placeholder:e.$t("tickets.replyPlaceholder"),rows:"3",onKeydown:he(A(Y,["ctrl"]),["enter"])},null,40,fs),[[q,h.value]]),s("button",{class:"send-btn",onClick:Y,disabled:!h.value.trim()||y.value},[y.value?(l(),c("span",_s)):(l(),B(n(Ne),{key:1,size:18})),D(" "+a(e.$t("tickets.send")),1)],8,gs)])):(l(),c("div",ys,[v(n(Le),{size:20}),s("span",null,a(e.$t("tickets.ticketClosed")),1)]))])):(l(),c("div",Oe,[s("div",Ge,[s("button",{class:"new-ticket-btn",onClick:G},[v(n(Ce),{size:18}),D(" "+a(e.$t("tickets.newTicket")),1)])]),j.value?(l(),c("div",We,[v(Q),s("p",null,a(e.$t("tickets.loadingTickets")),1)])):z.value.length>0?(l(),c("div",Ye,[(l(!0),c(M,null,U(z.value,t=>(l(),c("div",{key:t.id,class:"ticket-item",onClick:k=>te(t)},[s("div",Qe,[s("span",Xe,a(t.subject),1),s("span",{class:w(["ticket-status",`status-${t.status}`])},a(t.status===0?e.$t("tickets.statusOpen"):e.$t("tickets.statusClosed")),3)]),s("div",Ze,[s("span",xe,a(x(t.created_at)),1),s("span",es,"#"+a(t.id),1)])],8,Je))),128))])):(l(),c("div",ss,[v(n(Re),{size:48}),s("p",null,a(e.$t("tickets.noTickets")),1),s("button",{class:"create-ticket-btn",onClick:G},a(e.$t("tickets.createNew")),1)]))]))],64)),T.value?(l(),c("div",{key:2,class:"modal-overlay",onClick:I},[s("div",{class:"modal-content",onClick:o[3]||(o[3]=A(()=>{},["stop"]))},[s("div",bs,[s("h3",null,a(e.$t("tickets.createNew")),1),s("button",{class:"close-btn",onClick:I},[v(n(H),{size:20})])]),s("div",ws,[s("div",Ts,[s("label",null,a(e.$t("tickets.subject")),1),V(s("input",{type:"text","onUpdate:modelValue":o[1]||(o[1]=t=>r.value.subject=t),placeholder:e.$t("tickets.subjectPlaceholder")},null,8,Cs),[[q,r.value.subject]])]),s("div",$s,[s("label",null,a(e.$t("tickets.level")),1),s("div",Is,[(l(),c(M,null,U([0,1,2],t=>s("button",{key:t,class:w(["priority-btn",{active:r.value.level===t}]),onClick:k=>r.value.level=t},a(O(t)),11,Ss)),64))])]),s("div",Ls,[s("label",null,a(e.$t("tickets.message")),1),V(s("textarea",{"onUpdate:modelValue":o[2]||(o[2]=t=>r.value.message=t),placeholder:e.$t("tickets.messagePlaceholder"),rows:"4"},null,8,Ms),[[q,r.value.message]])])]),s("div",Ds,[s("button",{class:"cancel-btn",onClick:I},a(e.$t("common.cancel")),1),s("button",{class:"submit-btn",onClick:le,disabled:C.value},[C.value?(l(),c("span",zs)):L("",!0),D(" "+a(e.$t("common.submit")),1)],8,js)])])])):L("",!0),b.value?(l(),c("div",{key:3,class:"modal-overlay",onClick:R},[s("div",{class:"modal-content",onClick:o[4]||(o[4]=A(()=>{},["stop"]))},[s("div",Ps,[s("h3",null,a(e.$t("tickets.closeConfirmTitle")),1),s("button",{class:"close-btn",onClick:R},[v(n(H),{size:20})])]),s("div",Fs,[s("p",null,a(e.$t("tickets.closeConfirmText")),1)]),s("div",Es,[s("button",{class:"cancel-btn",onClick:R},a(e.$t("common.cancel")),1),s("button",{class:"confirm-close-btn danger",onClick:oe,disabled:f.value},[f.value?(l(),c("span",Us,[o[5]||(o[5]=s("span",{class:"spinner"},null,-1)),D(" "+a(e.$t("tickets.closing")),1)])):(l(),c("span",Rs,a(e.$t("tickets.closeTicket")),1))],8,Ns)])])])):L("",!0),v(De,{"show-popup":F.value,title:n(g).title,content:n(g).content,"cooldown-hours":n(g).cooldownHours,"close-wait-seconds":n(g).closeWaitSeconds,onClose:ie},null,8,["show-popup","title","content","cooldown-hours","close-wait-seconds"])]))}},Qs=ue(Vs,[["__scopeId","data-v-b6e8df60"]]);export{Qs as default};
